name: "KH_Macro lure: enable content + risky link"
description: "Inbound email contains a macro-capable attachment and text indicating the user is being prompted to enable macros/content, plus risky link infrastructure."
type: rule
severity: high

source: |
  type.inbound
  and any(attachments,
    .file_extension in~ ("docm","dotm","xlsm","xltm","pptm","ppsm","doc","xls","ppt","zip")
    and any(file.explode(.),
      any(.scan.strings.strings, strings.ilike(., "*enable content*"))
      or any(.scan.strings.strings, strings.ilike(., "*enable macros*"))
      or any(.scan.strings.strings, strings.ilike(., "*security warning*"))
      or any(.scan.strings.strings, strings.ilike(., "*enable editing*"))
    )
  )
  and any(body.links,
    .mismatched
    or .href_url.domain.root_domain in $url_shorteners
    or .href_url.domain.domain in $free_file_hosts
  )
