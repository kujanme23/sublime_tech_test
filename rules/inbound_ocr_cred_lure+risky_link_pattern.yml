name: "Inbound OCR credential lure + risky link pattern"
description: "OCR on the rendered message indicates a credential lure and the message contains risky link infrastructure (shortener/free file host/mismatched link)."
type: rule
severity: high

source: |
  type.inbound
  and any(
    file.explode(file.message_screenshot()),
    (
      strings.ilike(.scan.ocr.raw, "*password*")
      or strings.ilike(.scan.ocr.raw, "*sign in*")
      or strings.ilike(.scan.ocr.raw, "*login*")
      or strings.ilike(.scan.ocr.raw, "*verify*")
    )
    and
    (
      strings.ilike(.scan.ocr.raw, "*expire*")
      or strings.ilike(.scan.ocr.raw, "*expiration*")
      or strings.ilike(.scan.ocr.raw, "*reset*")
      or strings.ilike(.scan.ocr.raw, "*update*")
      or strings.ilike(.scan.ocr.raw, "*immediately*")
    )
  )
  and any(
    body.links,
    .mismatched
    or .href_url.domain.root_domain in $url_shorteners
    or .href_url.domain.domain in $free_file_hosts
  )
