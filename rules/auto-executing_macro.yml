name: "Attachment has auto-executing macro (unsolicited)"
description: "Unsolicited inbound email contains an Office attachment with an auto-executing macro."
type: rule
severity: high

source: |
  type.inbound
  and any(attachments,
    (
      .file_extension in~ $file_extensions_macros
      or (
        .file_extension is null
        and .file_type == "unknown"
        and .content_type == "application/octet-stream"
        and .size < 100000000
      )
    )
    and any(file.oletools(.).macros.keywords, .type =~ "autoexec")
  )
  and (
    not profile.by_sender().solicited
    or (
      profile.by_sender().any_messages_malicious_or_spam
      and not profile.by_sender().any_messages_benign
    )
  )
