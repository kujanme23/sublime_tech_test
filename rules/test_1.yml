type.inbound

// URL shortener link in body (uses built-in $url_shorteners list)
and any(body.links, .href_url.domain.root_domain in $url_shorteners)

// Sender / return-path mismatch
and sender.email.email != headers.return_path.email

// Reply-to differs from sender (classic BEC/phish pattern)
and headers.reply_to.email is not null
and headers.reply_to.email != sender.email.email

// Any authentication failures (spoof-y)
and (
  not headers.auth_summary.spf.pass
  or not headers.auth_summary.dmarc.pass
  or 'fail' in~ distinct(map(headers.hops, .authentication_results.dkim))
)

// Urgency / action language in subject or current thread text
and (
  regex.icontains(subject.subject, "(urgent|action required|verify|password|reset|invoice)")
  or regex.icontains(body.current_thread.text, "(urgent|action required|verify|password|reset|invoice)")
)
